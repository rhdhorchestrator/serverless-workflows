apiVersion: sonataflow.org/v1alpha08
kind: SonataFlow
metadata:
  name: greeting-auth
  namespace: rhdh-operator
  annotations:
    sonataflow.org/description: "Greeting workflow with authentication and token propagation"
    sonataflow.org/version: "1.0"
    sonataflow.org/profile: gitops
  labels:
    app: greeting-auth
    app.kubernetes.io/component: serverless-workflow
    app.kubernetes.io/managed-by: sonataflow-operator
    app.kubernetes.io/name: greeting-auth
    sonataflow.org/workflow-app: greeting-auth
spec:
  persistence:
    dbMigrationStrategy: service
    postgresql:
      secretRef:
        name: backstage-psql-secret-backstage
        passwordKey: POSTGRES_PASSWORD
        userKey: POSTGRES_USER
      serviceRef:
        databaseName: backstage_plugin_orchestrator
        databaseSchema: greeting-auth
        name: backstage-psql-backstage
        namespace: rhdh-operator
        port: 5432
  podTemplate:
    container:
      image: quay.io/chadcrum0/serverless-workflow-greeting-auth:latest
      env:
        - name: KEYCLOAK_AUTH_SERVER_URL
          valueFrom:
            secretKeyRef:
              name: greeting-auth-creds
              key: KEYCLOAK_AUTH_SERVER_URL
        - name: KEYCLOAK_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: greeting-auth-creds
              key: KEYCLOAK_CLIENT_ID
        - name: KEYCLOAK_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: greeting-auth-creds
              key: KEYCLOAK_CLIENT_SECRET
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: backstage-psql-secret-backstage
              key: POSTGRES_USER
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: backstage-psql-secret-backstage
              key: POSTGRES_PASSWORD
      envFrom:
        - secretRef:
            name: greeting-auth-creds
      resources: {}
  resources:
    configMaps:
      - configMap:
          name: greeting-auth-props
        workflowPath: .
      - configMap:
          name: greeting-auth-resources
        workflowPath: schemas
      - configMap:
          name: greeting-auth-resources
        workflowPath: specs
  flow:
    id: greeting-auth
    version: "1.0"
    specVersion: "1.0"
    name: Greeting workflow with OIDC authentication
    description: Demonstrates OIDC authentication with token propagation to external APIs
    annotations:
      - "workflow-type/infrastructure"
    dataInputSchema:
      failOnValidationErrors: true
      schema: schemas/greeting-auth.sw.input-schema.json
    extensions:
      - extensionid: workflow-output-schema
        outputSchema: schemas/workflow-output-schema.json
    start: ChooseOnLanguage
    functions:
      - name: getHeaders
        operation: specs/httpbin.yaml#getHeaders
      - name: greetFunction
        type: custom
        operation: sysout
      - name: successResult
        type: expression
        operation: '{
            "result": {
              "message": "Greeting workflow with authentication completed successfully",
              "outputs":[
                {
                    "key":"Selected language",
                    "value": .language
                },
                {
                    "key":"Greeting message",
                    "value": .greeting
                },
                {
                    "key":"Authentication status",
                    "value": (if .authTestResponse.headers.Authorization then "Token propagated successfully" else "Token not propagated" end)
                },
                {
                    "key":"Token details",
                    "value": (if (.authTestResponse.headers.Authorization and (.authTestResponse.headers.Authorization | contains("Bearer ey"))) then (.authTestResponse.headers.Authorization | split(" ")[1] | split(".")[1] | @base64d | fromjson | tostring) else "No valid JWT token" end)
                },
                {
                    "key":"All headers received",
                    "value": (.authTestResponse.headers | tostring)
                }
              ]
            }
          }'
    states:
      - name: ChooseOnLanguage
        type: switch
        dataConditions:
          - condition: .language == "English"
            transition: GreetInEnglish
          - condition: .language == "Spanish"
            transition: GreetInSpanish
        defaultCondition:
          transition: GreetInEnglish
      - name: GreetInEnglish
        type: inject
        data:
          greeting: "Hello from Authenticated YAML Workflow"
        transition: CallAuthenticatedAPI
      - name: GreetInSpanish
        type: inject
        data:
          greeting: "Saludos desde flujo de trabajo YAML autenticado"
        transition: CallAuthenticatedAPI
      - name: CallAuthenticatedAPI
        type: operation
        actions:
          - name: callHttpBinHeaders
            functionRef:
              refName: getHeaders
            actionDataFilter:
              toStateData: .authTestResponse
        transition: GreetPerson
      - name: GreetPerson
        type: operation
        actions:
          - name: greetAction
            functionRef:
              refName: greetFunction
              arguments:
                message: .greeting
          - name: setOutput
            functionRef:
              refName: successResult
        end:
          terminate: true
